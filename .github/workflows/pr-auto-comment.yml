name: PR Auto Comment & Label

on:
  pull_request_target:
    types: [opened, closed]

jobs:
  pr_feedback:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Add comment and labels when PR is opened
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            
            // Extract issue numbers from PR body (supports #123, fixes #123, closes #123, resolves #123, etc.)
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#(\d+)|#(\d+)/gi;
            const matches = [...prBody.matchAll(issuePattern)];
            const issueNumbers = [...new Set(matches.map(m => m[3] || m[4]).filter(Boolean))];
            
            let allLabels = new Set(['awaiting review', 'apertre3.0']);
            let linkedIssuesInfo = [];
            
            // Fetch labels from each linked issue
            for (const issueNumber of issueNumbers) {
              try {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber)
                });
                
                const issueLabels = issue.data.labels.map(label => 
                  typeof label === 'string' ? label : label.name
                );
                
                linkedIssuesInfo.push({
                  number: issueNumber,
                  title: issue.data.title,
                  labels: issueLabels
                });
                
                // Add issue labels to PR
                issueLabels.forEach(label => allLabels.add(label));
              } catch (error) {
                console.log(`Could not fetch issue #${issueNumber}: ${error.message}`);
              }
            }
            
            // Apply all collected labels to PR
            if (allLabels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: Array.from(allLabels)
              });
            }
            
            // Create professional comment
            let commentBody = `## Pull Request Received\n\n`;
            commentBody += `Thank you for your contribution to **College Daddy**. Your pull request has been received and is currently under review.\n\n`;
            
            if (linkedIssuesInfo.length > 0) {
              commentBody += `### Linked Issues\n\n`;
              commentBody += `This pull request addresses the following issue(s):\n\n`;
              
              for (const issue of linkedIssuesInfo) {
                commentBody += `- **Issue #${issue.number}**: ${issue.title}\n`;
                if (issue.labels.length > 0) {
                  commentBody += `  - Labels inherited: \`${issue.labels.join('`, `')}\`\n`;
                }
              }
              commentBody += `\n`;
            }
            
            commentBody += `### Pre-Merge Checklist\n\n`;
            commentBody += `Please ensure the following requirements are met before final approval:\n\n`;
            commentBody += `- [ ] Changes adhere to the project's contribution guidelines\n`;
            commentBody += `- [ ] Related issues are properly referenced in the PR description\n`;
            commentBody += `- [ ] All modifications have been tested and verified locally\n`;
            commentBody += `- [ ] Code follows established style and formatting standards\n`;
            commentBody += `- [ ] Documentation has been updated where necessary\n\n`;
            
            commentBody += `### Labels Applied\n\n`;
            commentBody += `The following labels have been assigned to this pull request:\n`;
            commentBody += Array.from(allLabels).map(label => `- \`${label}\``).join('\n');
            commentBody += `\n\n`;
            
            commentBody += `---\n\n`;
            commentBody += `Our team will review your submission shortly. We appreciate your effort in improving the platform for students.\n\n`;
            commentBody += `If you have any questions or require clarification, please feel free to comment below.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Add thank-you comment when merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const contributor = context.payload.pull_request.user.login;
            
            const commentBody = `## Pull Request Merged Successfully\n\n` +
              `**Contributor**: @${contributor}\n\n` +
              `Your pull request has been successfully merged into the main codebase. ` +
              `Thank you for your valuable contribution to **College Daddy**.\n\n` +
              `### Impact\n\n` +
              `Your changes are now part of the production environment and will benefit students using the platform.\n\n` +
              `### Next Steps\n\n` +
              `We encourage you to:\n\n` +
              `- Star the repository to support the project's visibility\n` +
              `- Watch for updates and participate in future discussions\n` +
              `- Continue contributing to enhance the platform\n\n` +
              `---\n\n` +
              `We value your commitment to improving educational technology and look forward to your continued involvement in the project.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Update labels when merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Remove 'awaiting review' label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'awaiting review'
              });
            } catch (error) {
              console.log(`Label 'awaiting review' not found or already removed`);
            }
            
            // Add 'mugenkyou' label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['mugenkyou']
            });
